{
  "tag": "Airdrop",
  "count": 1,
  "metadata": {
    "totalResults": 1,
    "totalPages": 1
  },
  "last_rateLimit": {
    "limit": 20,
    "remaining": 13,
    "reset": 1771760940
  },
  "findings": [
    {
      "id": "6102",
      "kind": "GIT",
      "auditfirm_id": "2",
      "impact": "MEDIUM",
      "finders_count": 2,
      "protocol_id": "76",
      "title": "[M-04] It's possible to swap NFT token ids without fee and also attacker can wrap unwrap all the NFT token balance of the Pair contract and steal their air drops for those token ids",
      "content": "\n<https://github.com/code-423n4/2022-12-caviar/blob/0212f9dc3b6a418803dbfacda0e340e059b8aae2/src/Pair.sol#L217-L243> <br><https://github.com/code-423n4/2022-12-caviar/blob/0212f9dc3b6a418803dbfacda0e340e059b8aae2/src/Pair.sol#L248-L262>\n\nUsers can `wrap()` their NFT tokens (which id is whitelisted) and receive `1e18` fractional token or they can pay `1e18` fractional token and unwrap NFT token. there is two issue here:\n\n1.  anyone can swap their NFT token id with another NFT token id without paying any fee(both ids should be whitelisted). it's swap without fee.\n2.  attacker can swap his NFT token(with whitelisted id) for all the NFT balance of contract and steal those NFT tokens airdrop all in one transaction.\n\n### Proof of Concept\n\nThis is `wrap()` and `unwrap()` code:\n\n        function wrap(uint256[] calldata tokenIds, bytes32[][] calldata proofs)\n            public\n            returns (uint256 fractionalTokenAmount)\n        {\n            // *** Checks *** //\n\n            // check that wrapping is not closed\n            require(closeTimestamp == 0, \"Wrap: closed\");\n\n            // check the tokens exist in the merkle root\n            _validateTokenIds(tokenIds, proofs);\n\n            // *** Effects *** //\n\n            // mint fractional tokens to sender\n            fractionalTokenAmount = tokenIds.length * ONE;\n            _mint(msg.sender, fractionalTokenAmount);\n\n            // *** Interactions *** //\n\n            // transfer nfts from sender\n            for (uint256 i = 0; i < tokenIds.length; i++) {\n                ERC721(nft).safeTransferFrom(msg.sender, address(this), tokenIds[i]);\n            }\n\n            emit Wrap(tokenIds);\n        }\n\n        function unwrap(uint256[] calldata tokenIds) public returns (uint256 fractionalTokenAmount) {\n            // *** Effects *** //\n\n            // burn fractional tokens from sender\n            fractionalTokenAmount = tokenIds.length * ONE;\n            _burn(msg.sender, fractionalTokenAmount);\n\n            // *** Interactions *** //\n\n            // transfer nfts to sender\n            for (uint256 i = 0; i < tokenIds.length; i++) {\n                ERC721(nft).safeTransferFrom(address(this), msg.sender, tokenIds[i]);\n            }\n\n            emit Unwrap(tokenIds);\n        }\n\nAs you can see it's possible to wrap one NFT token (which id is whitelisted and is in merkle tree) and unwrap another NFT token without paying fee. so Pair contract create NFT swap without fee for users but there is no fee generated for those who wrapped and put their fractional tokens as liquidity providers.\nThe other issue with this is that some NFT tokens air drop new NFT tokens for NFT holders by making NFT holders to call `getAirdrop()` function. attacker can use this swap functionality to get air drop token for all the NFT balance of the Pair contract. to steps to perform this attack:\n\n1.  if Pair contract is for NFT1 and baseToken1 and also merkle tree root hash is 0x0.\n2.  users deposited 100 NFT1 tokens to the Pair contract.\n3.  NFT1 decide to airdrop some new tokens for token holders and token holders need to call `nft.getAirDrop(id)` while they own the NFT id.\n4.  attacker would create a contract and buy one of the NFT1 tokens (attackerID1) and wrap it to receive `1e18` fractional tokens and perform this steps in the contract:<br>\n    4.1 loop through all the NFT tokens in the Pair contract balance and:<br>\n    4.2 unwrap NFT token id=i from Pair contract by paying `1e18` fractional token.<br>\n    4.3 call `nft.getAirDrop(i)` and receive the new airdrop token. (the name of the function can be other thing not exactly `getAirDrop()`)<br>\n    4.4 wrap NFT token id=i and receive `1e18` fractional token.\n\n5. in the end attacker would unwrap attackerID1 token from Pair contract.<br>\nso attacker was able to receive all the air drops of the NFT tokens that were in the contract address, there could be 100 or 1000 NFT tokens in the contract address and attacker can steal their air drops in one transaction(by writing a contract). those air drops belongs to all the fractional owners and contract shouldn't allow one user to take all the air drops for himself. as airdrops are common in NFT collections so this bug is critical and would happen.\n\nalso some of the NFT tokens allows users to stake some tokens for their NFT tokens and receive rewards(for example BAYC/MAYC). if a user stakes tokens for his NFT tokens then wrap those NFT tokens then it would be possible for attacker to unwrap those tokens and steal user staked amounts. in this scenario user made a risky move and wrapped NFT tokens while they have stake but as a lot of users wants to stake for their NFTs this would make them unable to use caviar protocol.\n\nalso any other action that attacker can perform by becoming the owner of the NFT token is possible by this attack and if that action can harm the NFT token holders then attacker can harm by doing this attack and performing that action.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nThe real solution to prevent this attack (stealing air drops) can be hard. some of the things can be done is:\n* create functionality so admin can call `getAirDrop()` functions during the airdrops before attacker.\n* call `getAirDrop()` (which admin specified) function before unwrapping tokens.\n* make some fee for NFT token unwrapping.\n* create some lock time(some days) for each wrapped NFT that in that lock time only the one who supplied that token can unwrap it.\n* create some delay for unwrapping tokens and if user wants to unwrap token he would receive it after this delay.\n\n**[outdoteth (Caviar) acknowledged, but disagreed with severity](https://github.com/code-423n4/2022-12-caviar-findings/issues/367#event-8160517199)**\n\n**[berndartmueller (judge) decreased severity to Medium](https://github.com/code-423n4/2022-12-caviar-findings/issues/367#event-8227237597)**\n\n\n\n***\n\n",
      "summary": "\nThis bug report is about a vulnerability in the Pair contract code, which allows users to wrap and unwrap NFT tokens without paying any fees. This can be exploited in a variety of ways, including stealing NFT tokens airdrops, stealing staked amounts, and performing other actions that can harm NFT token holders. The vulnerability was discovered by using VIM.\n\nThe impact of this vulnerability is that users can wrap their NFT tokens (which id is whitelisted) and receive fractional tokens, or pay fractional tokens and unwrap NFT tokens. This allows the attacker to swap their NFT token id with another NFT token id without paying any fee, as long as both ids are whitelisted. Furthermore, the attacker can swap their NFT token (with whitelisted id) for all the NFT balance of the contract and steal those NFT tokens airdrop all in one transaction.\n\nTo mitigate this vulnerability, the real solution is hard. Some of the things that can be done are: creating functionality so admin can call `getAirDrop()` functions during the airdrops before the attacker, calling `getAirDrop()` (which admin specified) function before unwrapping tokens, making some fee for NFT token unwrapping, creating some lock time for each wrapped NFT, and creating some delay for unwrapping tokens.",
      "report_date": {},
      "contest_prize_txt": "$36,500 USDC",
      "contest_link": "https://code4rena.com/contests/2022-12-caviar-contest",
      "sponsor_name": "Caviar",
      "sponsor_link": "https://twitter.com/caviarAMM",
      "quality_score": 5,
      "general_score": 4,
      "source_link": "https://code4rena.com/reports/2022-12-caviar",
      "github_link": "https://github.com/code-423n4/2022-12-caviar-findings/issues/367",
      "pdf_link": "",
      "pdf_page_from": 0,
      "contest_id": "193",
      "slug": "m-04-its-possible-to-swap-nft-token-ids-without-fee-and-also-attacker-can-wrap-unwrap-all-the-nft-token-balance-of-the-pair-contract-and-steal-their-air-drops-for-those-token-ids-code4rena-caviar-caviar-contest-git",
      "firm_name": "Code4rena",
      "firm_logo_square": "code4rena_square.png",
      "protocol_name": "Caviar",
      "bookmarked": false,
      "read": false,
      "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
      },
      "protocols_protocol": {
        "name": "Caviar",
        "protocols_protocolcategoryscore": [
          {
            "protocols_protocolcategory": {
              "title": "Dexes"
            },
            "score": 0.5
          },
          {
            "protocols_protocolcategory": {
              "title": "CDP"
            },
            "score": 0.5
          },
          {
            "protocols_protocolcategory": {
              "title": "Services"
            },
            "score": 0.5
          },
          {
            "protocols_protocolcategory": {
              "title": "Cross Chain"
            },
            "score": 0.5
          },
          {
            "protocols_protocolcategory": {
              "title": "Indexes"
            },
            "score": 0.5
          }
        ]
      },
      "issues_issuetagscore": [
        {
          "tags_tag": {
            "title": "Ownership"
          }
        },
        {
          "tags_tag": {
            "title": "NFT"
          }
        },
        {
          "tags_tag": {
            "title": "Airdrop"
          }
        }
      ]
    }
  ]
}