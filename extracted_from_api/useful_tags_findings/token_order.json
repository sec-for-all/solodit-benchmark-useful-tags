{
  "tag": "Token Order",
  "count": 1,
  "metadata": {
    "totalResults": 1,
    "totalPages": 1
  },
  "last_rateLimit": {
    "limit": 20,
    "remaining": 4,
    "reset": 1771761120
  },
  "findings": [
    {
      "id": "1002",
      "kind": "GIT",
      "auditfirm_id": "2",
      "impact": "HIGH",
      "finders_count": 1,
      "protocol_id": "322",
      "title": "[H-17] TWAPOracle might register with wrong token order",
      "content": "_Submitted by cmichel_\n\nThe `TWAPOracle.registerPair` function takes in a `factory` and (`token0, token1)`.\nThe function accepts a `_factory` argument which means any Uniswap-like factory can be used.\n\nWhen using the actual Uniswap factory's `IUniswapV2Factory(factory).getPair(token0, token1)` call, it could be that the `token0` and `token1` are reversed as it [ignores the order](https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Factory.sol#L35).\n\nMeaning, the `price0/1CumulativeLast` could also be reversed as it matches the internal order.\nThe code however pushes the `_pairs` assuming that the internal `price0CumulativeLast, price1CumulativeLast` order matches the order of the function arguments `token0, token1`.\n\n```solidity\n_pairs.push(\n    PairData({\n        pair: pairAddr,\n        token0: token0,\n        token1: token1,\n        price0CumulativeLast: price0CumulativeLast,\n        price1CumulativeLast: price1CumulativeLast,\n        blockTimestampLast: blockTimestampLast,\n        price0Average: FixedPoint.uq112x112({_x: 0}),\n        price1Average: FixedPoint.uq112x112({_x: 0})\n    })\n);\n```\n\n#### Impact\n\nThe prices could be inverted which leads to the oracle providing wrong prices.\n\n#### Recommended Mitigation Steps\n\nIt should be checked if Uniswap's internal order matches the order of the `token0/1` function arguments.\nIf not, the cumulative prices must be swapped.\n\n```solidity\n// pseudocode\nIUniswapV2Pair pair = IUniswapV2Pair(\n    IUniswapV2Factory(factory).getPair(token0, token1)\n);\npairAddr = address(pair);\nprice0CumulativeLast = pair.price0CumulativeLast();\nprice1CumulativeLast = pair.price1CumulativeLast();\n(price0CumulativeLast, price1CumulativeLast) = token0 == pair.token0() ? (price0CumulativeLast, price1CumulativeLast) : (price1CumulativeLast, price0CumulativeLast);\n```\n\n> The same issue exists in `update`\n\n**[SamSteinGG (Vader) confirmed](https://github.com/code-423n4/2021-11-vader-findings/issues/171)**\n> The TWAP oracle module has been completely removed and redesigned from scratch as LBTwap that is subject of the new audit.\n\n",
      "summary": "\nA bug has been identified in the `TWAPOracle.registerPair` function of the Uniswap-like factory. The function takes in a `factory` and (`token0, token1)` and accepts a `_factory` argument, meaning any Uniswap-like factory can be used. However, when using the actual Uniswap factory's `IUniswapV2Factory(factory).getPair(token0, token1)` call, the order of `token0` and `token1` can be reversed, which can lead to the oracle providing wrong prices.\n\nThe recommended mitigation steps for this issue are to check if the Uniswap's internal order matches the order of the `token0/1` function arguments. If not, the cumulative prices must be swapped. This issue also exists in the `update` function.",
      "report_date": {},
      "contest_prize_txt": "$75,000 USDC",
      "contest_link": "https://code4rena.com/contests/2021-11-vader-protocol-contest",
      "sponsor_name": "Vader Protocol",
      "sponsor_link": "https://twitter.com/VaderProtocol",
      "quality_score": 3,
      "general_score": 3,
      "source_link": "https://code4rena.com/reports/2021-11-vader",
      "github_link": "https://github.com/code-423n4/2021-11-vader-findings/issues/171",
      "pdf_link": "",
      "pdf_page_from": 0,
      "contest_id": "52",
      "slug": "h-17-twaporacle-might-register-with-wrong-token-order-code4rena-vader-protocol-vader-protocol-contest-git",
      "firm_name": "Code4rena",
      "firm_logo_square": "code4rena_square.png",
      "protocol_name": "Vader Protocol",
      "bookmarked": false,
      "read": false,
      "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
      },
      "protocols_protocol": {
        "name": "Vader Protocol",
        "protocols_protocolcategoryscore": [
          {
            "protocols_protocolcategory": {
              "title": "Oracle"
            },
            "score": 1
          },
          {
            "protocols_protocolcategory": {
              "title": "Liquid Staking"
            },
            "score": 0.5
          },
          {
            "protocols_protocolcategory": {
              "title": "Bridge"
            },
            "score": 0.5
          },
          {
            "protocols_protocolcategory": {
              "title": "CDP"
            },
            "score": 0.5
          },
          {
            "protocols_protocolcategory": {
              "title": "Yield Aggregator"
            },
            "score": 0.5
          }
        ]
      },
      "issues_issuetagscore": [
        {
          "tags_tag": {
            "title": "Token Order"
          }
        }
      ]
    }
  ]
}