---
name: vault-share-checklist
description: 检查基于“资产池-份额”模型的智能合约中，资产与份额记账不同步导致的价值计算偏差问题
---

# 资产与份额记账不同步导致的价值计算偏差

## 核心原则

在任何“资产池-份额”模型（如 Vault、流动性质押、LP 池等）中，份额的价值由 总资产价值 / 总份额数量 决定。当资产或份额的记账更新存在时间差或依赖外部触发时，必须确保价值计算函数能正确核算所有“在途”或“待处理”的金额，以防止价值被错误地稀释或夸大。

## 审计步骤与检查点

1. 识别异步或多步的资产/份额变更流程：
   1. 检查存款/取款流程： 用户的资产是立即被计入池中，还是先进入一个临时区域？份额代币是立即铸造，还是在某个周期结束或特定函数被调用后才批量铸造？用户的份额代币是立即被销毁，还是被标记为“待赎回”？池中的对应资产是立即被移出，还是进入一个等待期或等待批量处理？
   1. 关键信号词： 留意代码中是否存在 pending, queued, batched, unbonding, locked, epoch,等变量，它们通常是异步流程的标志。
1. 定位核心的价值（汇率）计算逻辑：
   1. 找到系统中执行存款、取款、或计算收益分配时的核心逻辑，用于计算“每份额等同于多少基础资产”的函数或代码块。
   1. 确认计算公式是否为 价值 = A / S 的变体，其中，A 代表总资产的某种计量，S 代表总份额的某种计量
1. 核对价值计算是否已对齐异步状态，这是最关键的一步。在找到上述计算逻辑后，进行以下核对：
   1. 检查分子（总资产 A）：
      1. 是否存在待处理的提款？如果有，那么这部分“即将离开但物理上仍在池中”的资产，是否已从总资产 A 中减去？
      1. 是否存在待处理的存款？ 如果用户的资产已转入合约但份额尚未铸造，那么这部分资产，是否已加入到总资产 A 中？
   1. 检查分母（总份额 S）：
      1. 是否存在待处理的存款？如果用户的资产已进入池子，但份额还未铸造，那么这部分“即将诞生”的份额，是否已加入到总份额 S 中？
      1. 是否存在待处理的提款？如果用户的份额已被销毁或锁定，但这部分份额对应的资产还未从池中移除，那么这部分“已经失效”的份额，是否已从总份额 S 中减去？

如果上述核对中，分子（资产）和分母（份额）的记账范围未严格对齐——即，计算逻辑使用了某个时间点的资产总量和另一个时间点的份额总量——则该系统存在价值计算偏差漏洞。